client_max_body_size 2G;

resolver 127.0.0.11 valid=30s; # docker dns

upstream authentication {
    server authentication-service:8080;
}

upstream broker {
    server broker-service:15672;
}

upstream analyse {
    server analyse-service:5000;
}

upstream metadata {
    server metadata-service:9099;
}

upstream search {
    server search-db:9200;
}

upstream ui {
    server ui:3000;
}

upstream upload {
    server upload-service:1080;
}

upstream search-db-dashboard {
    server search-db-dashboard:5601;
}

server {
    listen 80 default_server;
    server_name _;

    location /admin/dashboard {
        proxy_set_header        Host $host;
        proxy_set_header        X-Real-IP $remote_addr;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header        X-Forwarded-Proto $scheme;
        proxy_pass              http://search-db-dashboard;
        proxy_read_timeout      90;
    }

    location /admin/broker {
        proxy_set_header        Host $host;
        proxy_set_header        X-Real-IP $remote_addr;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header        X-Forwarded-Proto $scheme;
        proxy_pass              http://broker;
        proxy_read_timeout      90;
    }

    location /api/broker {
        rewrite /api/broker/(.*) /admin/broker/api/$1 break;
        proxy_set_header        Host $host;
        proxy_set_header        X-Real-IP $remote_addr;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header        X-Forwarded-Proto $scheme;
        proxy_pass              http://broker;
        proxy_read_timeout      90;
    }

    location /api/analyse {
        proxy_set_header        Host $host;
        proxy_set_header        X-Real-IP $remote_addr;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header        X-Forwarded-Proto $scheme;
        proxy_pass              http://analyse;
        proxy_read_timeout      90;
    }

    location /api/upload {
        proxy_set_header        Host $host;
        proxy_set_header        X-Real-IP $remote_addr;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header        X-Forwarded-Proto $scheme;
        proxy_pass              http://upload;
        proxy_read_timeout      90;
    }

    location /broker {
        proxy_set_header        Host $host;
        proxy_set_header        X-Real-IP $remote_addr;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header        X-Forwarded-Proto $scheme;
        proxy_pass              http://broker;
        proxy_read_timeout      90;
    }

    location /api/auth {
        rewrite /api/auth/(.*) /$1 break;
        proxy_set_header        Host $host;
        proxy_set_header        X-Real-IP $remote_addr;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header        X-Forwarded-Proto $scheme;
        proxy_pass              http://authentication;
        proxy_read_timeout      90;
    }

    location /api {
        proxy_set_header        Host $host;
        proxy_set_header        X-Real-IP $remote_addr;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header        X-Forwarded-Proto $scheme;
        proxy_pass              http://metadata;
        proxy_read_timeout      90;
    }

    location /pid {
        rewrite /pid/(.*) /api/pid/$1 break;
        proxy_set_header        Host $host;
        proxy_set_header        X-Real-IP $remote_addr;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header        X-Forwarded-Proto $scheme;
        proxy_pass              http://metadata;
        proxy_read_timeout      90;
    }

    location /retrieve {
        rewrite /retrieve/(.*) /$1 break;
        proxy_set_header        Host $host;
        proxy_set_header        X-Real-IP $remote_addr;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header        X-Forwarded-Proto $scheme;
        proxy_pass              http://search;
        proxy_read_timeout      90;
    }

    location / {
        proxy_set_header        Host $host;
        proxy_set_header        X-Real-IP $remote_addr;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header        X-Forwarded-Proto $scheme;
        proxy_pass              http://ui;
        proxy_read_timeout      90;
    }
}
