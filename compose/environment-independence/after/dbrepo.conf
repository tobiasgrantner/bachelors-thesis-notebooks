client_max_body_size 2G;

resolver 127.0.0.11 valid=30s; # docker dns

upstream authentication {
    server authentication-service:8080;
}

upstream user {
    server user-service:9098;
}

upstream broker {
    server broker-service:15672;
}

upstream analyse {
    server analyse-service:5000;
}

upstream metadata {
    server metadata-service:9099;
}

upstream identifier {
    server identifier-service:9096;
}

upstream query {
    server query-service:9093;
}

upstream table {
    server table-service:9094;
}

upstream database {
    server database-service:9092;
}

upstream container {
    server container-service:9091;
}

upstream semantics {
    server semantics-service:9097;
}

upstream search {
    server search-db:9200;
}

upstream ui {
    server ui:3000;
}

server {
    listen 80 default_server;
    server_name _;

    location /api/auth {
        rewrite /api/auth/(.*) /$1 break;
        proxy_set_header        Host $host;
        proxy_set_header        X-Real-IP $remote_addr;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header        X-Forwarded-Proto $scheme;
        proxy_pass              http://authentication;
        proxy_read_timeout      90;
    }

    location /api/user {
        proxy_set_header        Host $host;
        proxy_set_header        X-Real-IP $remote_addr;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header        X-Forwarded-Proto $scheme;
        proxy_pass              http://user;
        proxy_read_timeout      90;
    }

    location /api/broker {
        rewrite /api/broker/(.*) /api/$1 break;
        proxy_set_header        Host $host;
        proxy_set_header        X-Real-IP $remote_addr;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header        X-Forwarded-Proto $scheme;
        proxy_pass              http://broker;
        proxy_read_timeout      90;
    }

    location /api/analyse {
        proxy_set_header        Host $host;
        proxy_set_header        X-Real-IP $remote_addr;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header        X-Forwarded-Proto $scheme;
        proxy_pass              http://analyse;
        proxy_read_timeout      90;
    }

    location /api/oai {
        proxy_set_header        Host $host;
        proxy_set_header        X-Real-IP $remote_addr;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header        X-Forwarded-Proto $scheme;
        proxy_pass              http://metadata;
        proxy_read_timeout      90;
    }

    location /api/maintenance {
        proxy_set_header        Host $host;
        proxy_set_header        X-Real-IP $remote_addr;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header        X-Forwarded-Proto $scheme;
        proxy_pass              http://user;
        proxy_read_timeout      90;
    }

    location /api/identifier {
        proxy_set_header        Host $host;
        proxy_set_header        X-Real-IP $remote_addr;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header        X-Forwarded-Proto $scheme;
        proxy_pass              http://identifier;
        proxy_read_timeout      90;
    }

    location /api/pid {
        proxy_set_header        Host $host;
        proxy_set_header        X-Real-IP $remote_addr;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header        X-Forwarded-Proto $scheme;
        proxy_pass              http://identifier;
        proxy_read_timeout      90;
    }

    location /pid {
        rewrite /pid/(.*) /api/pid/$1 break;
        proxy_set_header        Host $host;
        proxy_set_header        X-Real-IP $remote_addr;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header        X-Forwarded-Proto $scheme;
        proxy_pass              http://identifier;
        proxy_read_timeout      90;
    }

    location ~ ^/api/database/[0-9]+/query {
        proxy_set_header        Host $host;
        proxy_set_header        X-Real-IP $remote_addr;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header        X-Forwarded-Proto $scheme;
        proxy_pass              http://query;
        proxy_read_timeout      90;
    }

    location ~ ^/api/database/[0-9]+/view {
        proxy_set_header        Host $host;
        proxy_set_header        X-Real-IP $remote_addr;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header        X-Forwarded-Proto $scheme;
        proxy_pass              http://query;
        proxy_read_timeout      90;
    }

    location ~ ^/api/database/[0-9]+/table/[0-9]+/history {
        proxy_set_header        Host $host;
        proxy_set_header        X-Real-IP $remote_addr;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header        X-Forwarded-Proto $scheme;
        proxy_pass              http://query;
        proxy_read_timeout      90;
    }

    location ~ ^/api/database/[0-9]+/table/[0-9]+/data {
        proxy_set_header        Host $host;
        proxy_set_header        X-Real-IP $remote_addr;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header        X-Forwarded-Proto $scheme;
        proxy_pass              http://query;
        proxy_read_timeout      90;
    }

    location ~ ^/api/database/[0-9]+/table/[0-9]+/query {
        proxy_set_header        Host $host;
        proxy_set_header        X-Real-IP $remote_addr;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header        X-Forwarded-Proto $scheme;
        proxy_pass              http://query;
        proxy_read_timeout      90;
    }

    location ~ ^/api/database/[0-9]+/table/[0-9]+/export {
        proxy_set_header        Host $host;
        proxy_set_header        X-Real-IP $remote_addr;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header        X-Forwarded-Proto $scheme;
        proxy_pass              http://query;
        proxy_read_timeout      90;
    }

    location ~ ^/api/database/[0-9]+/table/[0-9]+/consumer {
        proxy_set_header        Host $host;
        proxy_set_header        X-Real-IP $remote_addr;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header        X-Forwarded-Proto $scheme;
        proxy_pass              http://query;
        proxy_read_timeout      90;
    }

    location ~ ^/api/database/[0-9]+/version {
        proxy_set_header        Host $host;
        proxy_set_header        X-Real-IP $remote_addr;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header        X-Forwarded-Proto $scheme;
        proxy_pass              http://query;
        proxy_read_timeout      90;
    }

    location ~ ^/api/database/[0-9]+/table {
        proxy_set_header        Host $host;
        proxy_set_header        X-Real-IP $remote_addr;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header        X-Forwarded-Proto $scheme;
        proxy_pass              http://table;
        proxy_read_timeout      90;
    }

    location ~ ^/api/database {
        proxy_set_header        Host $host;
        proxy_set_header        X-Real-IP $remote_addr;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header        X-Forwarded-Proto $scheme;
        proxy_pass              http://database;
        proxy_read_timeout      90;
    }

    location ~ ^/api/database/[0-9]+/access {
        proxy_set_header        Host $host;
        proxy_set_header        X-Real-IP $remote_addr;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header        X-Forwarded-Proto $scheme;
        proxy_pass              http://database;
        proxy_read_timeout      90;
    }

    location /api/container {
        proxy_set_header        Host $host;
        proxy_set_header        X-Real-IP $remote_addr;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header        X-Forwarded-Proto $scheme;
        proxy_pass              http://container;
        proxy_read_timeout      90;
    }

    location /api/image {
        proxy_set_header        Host $host;
        proxy_set_header        X-Real-IP $remote_addr;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header        X-Forwarded-Proto $scheme;
        proxy_pass              http://container;
        proxy_read_timeout      90;
    }

    location /api/semantic {
        proxy_set_header        Host $host;
        proxy_set_header        X-Real-IP $remote_addr;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header        X-Forwarded-Proto $scheme;
        proxy_pass              http://semantics;
        proxy_read_timeout      90;
    }

    location /retrieve {
        rewrite /retrieve/(.*) /$1 break;
        proxy_set_header        Host $host;
        proxy_set_header        X-Real-IP $remote_addr;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header        X-Forwarded-Proto $scheme;
        proxy_pass              http://search;
        proxy_read_timeout      90;
    }

    location / {
        proxy_set_header        Host $host;
        proxy_set_header        X-Real-IP $remote_addr;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header        X-Forwarded-Proto $scheme;
        proxy_pass              http://ui;
        proxy_read_timeout      90;
    }
}
